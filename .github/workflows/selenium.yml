name: Selenium Login Test

on:
  push:
    branches:
      - feature/selenium-login-ci

jobs:
  login-test:
    runs-on: ubuntu-latest

    steps:

      # ------------------------------
      # 1. Checkout Repository
      # ------------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # ------------------------------
      # 2. Get GitHub Runner Public IP
      # ------------------------------
      - name: Get GitHub Runner IP
        run: |
          IP=$(curl -s https://api.ipify.org)
          echo "RUNNER_IP=$IP" >> $GITHUB_ENV
          echo "GitHub Runner IP: $IP"

      # ------------------------------
      # 3. Authenticate to GCP
      # ------------------------------
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      - name: Set GCP Project
        run: |
          gcloud config set project ${{ secrets.GCP_PROJECT_ID }}

      # ------------------------------
      # 4. Create or Update Firewall Rule Safely
      # ------------------------------
      - name: Create or Update Firewall for GitHub Runner
        run: |
          echo "Checking if selenium-test-firewall exists..."

          if gcloud compute firewall-rules describe selenium-test-firewall > /dev/null 2>&1; then
            echo "Firewall exists. Updating source range to ${RUNNER_IP}"

            gcloud compute firewall-rules update selenium-test-firewall \
              --source-ranges="${RUNNER_IP}/32"

          else
            echo "Firewall does not exist. Creating it..."

            gcloud compute firewall-rules create selenium-test-firewall \
              --direction=INGRESS \
              --priority=1000 \
              --network=default \
              --action=ALLOW \
              --rules=tcp:3000 \
              --source-ranges="${RUNNER_IP}/32" \
              --description="GitHub Selenium temporary access"

          
          fi

          if gcloud compute firewall-rules describe selenium-api-firewall > /dev/null 2>&1; then
            echo "Firewall exists. Updating source range to ${RUNNER_IP}"

            gcloud compute firewall-rules update selenium-api-firewall \
              --source-ranges="${RUNNER_IP}/32"

          else
            echo "Firewall does not exist. Creating it..."


            gcloud compute firewall-rules create selenium-api-firewall \
              --direction=INGRESS \
              --priority=1000 \
              --network=ctmcops-dev-vpc \
              --action=ALLOW \
              --rules=tcp:8004 \
              --source-ranges="${RUNNER_IP}/32" \
              --description="GitHub Selenium temporary access"
          fi

      # ------------------------------
      # 5. Setup Selenium Environment
      # ------------------------------
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Chrome
        uses: browser-actions/setup-chrome@v1

      - name: Install Python dependencies
        run: |
          pip install selenium webdriver-manager

      # ------------------------------
      # 6. Run Selenium Login Test
      # ------------------------------
      - name: Debug App URL
        run: |
          echo "APP_URL is: ${{ secrets.APP_URL }}"

      - name: Run Login Test
        env:
          APP_URL: ${{ secrets.APP_URL }}
          TEST_EMAIL: ${{ secrets.TEST_EMAIL }}
          TEST_PASSWORD: ${{ secrets.TEST_PASSWORD }}
        run: |
          curl -vvv "${APP_URL}"
          curl -vvv "http://34.47.214.175:8004/
          python "selenium test(product)/test_login.py"

      # ------------------------------
      # 7. Upload Debug Artifacts (on failure)
      # ------------------------------
      - name: Upload Selenium Debug Artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: selenium-debug
          path: |
            home_page_failure.png
            home_page_source.html

      # ------------------------------
      # 8. Remove Firewall Rule (Always)
      # ------------------------------
      #- name: Remove GitHub Runner Firewall
        #if: always()
        #run: |
          #echo "Cleaning up firewall rule..."

          #if gcloud compute firewall-rules describe selenium-test-firewall > /dev/null 2>&1; then
           # gcloud compute firewall-rules delete selenium-test-firewall --quiet
          #else
            #echo "Firewall rule already removed"
          #fi
